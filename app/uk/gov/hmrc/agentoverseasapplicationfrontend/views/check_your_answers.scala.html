@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Configuration
@import play.mvc.Call
@import uk.gov.hmrc.agentoverseasapplicationfrontend.controllers.routes
@import uk.gov.hmrc.agentoverseasapplicationfrontend.models._
@import uk.gov.hmrc.agentoverseasapplicationfrontend.models.Yes
@import uk.gov.hmrc.agentoverseasapplicationfrontend.forms._
@import scala.collection.immutable.SortedSet
@import uk.gov.hmrc.play.views.html.helpers.form
@import uk.gov.hmrc.agentoverseasapplicationfrontend.views.html.helpers.check_answers_div




@(agentSession: AgentSession, countryName: String, backLink: String)(implicit request: Request[_], messages: Messages, configuration: Configuration)


@showFullBusinessDetails = {
    @agentSession.registeredForUkTax.map { isRegisteredForUKTax =>
        @check_answers_div(Messages("checkAnswers.registeredForUKTax.title"),  isRegisteredForUKTax, "isRegisteredForTax", routes.ChangingAnswersController.changeRegisteredForUKTax())
        
        <script>gaSendEvent('check-answers-registered-for-tax-title')</script>
        
        @if(isRegisteredForUKTax == Yes) {
            @agentSession.personalDetails.flatMap(_.nino).map { nino =>
                @check_answers_div(Messages("checkAnswers.personalDetails.nino.title"),  nino, "nino", routes.ChangingAnswersController.changePersonalDetails())
                <script>gaSendEvent('check-answers-nino-title')</script>
            }

            @agentSession.personalDetails.flatMap(_.saUtr).map { saUtr =>
                @check_answers_div(Messages("checkAnswers.personalDetails.saUtr.title"),  saUtr, "saUtr", routes.ChangingAnswersController.changePersonalDetails())
                <script>gaSendEvent('check-answers-saUtr-title')</script>
            }
        }
    }

    @agentSession.companyRegistrationNumber.map(_.registrationNumber).map { crn =>
        @if(crn.nonEmpty) {
            @check_answers_div(Messages("checkAnswers.companyRegistrationNumber.title"), crn.get.value, "companyRegNo", routes.ChangingAnswersController.changeCompanyRegistrationNumber())
        } else {
            @check_answers_div(Messages("checkAnswers.companyRegistrationNumber.title"), Messages("checkAnswers.companyRegistrationNumber.empty"), "companyRegNo",
            routes.ChangingAnswersController.changeCompanyRegistrationNumber())
        }
        
        <script>gaSendEvent('check-answers-company-registration-number-title')</script>
      
    }

    @agentSession.taxRegistrationNumbers match {
        case Some(trns) if trns.nonEmpty => {
            @check_answers_div(
                Messages("checkAnswers.taxRegistrationNumbers.title"),
                Html(agentSession.taxRegistrationNumbers.map(_.map(_.value)).getOrElse(SortedSet.empty[String]).mkString("<br>")),
              "taxRegistrationNumbersTitle",
                routes.ChangingAnswersController.changeYourTaxRegistrationNumbers())
            
            <script>gaSendEvent('check-answers-tax-registration-numbers')</script>
          
        }
        case _ => {
            @check_answers_div(
                Messages("checkAnswers.taxRegistrationNumbers.title"),
                Messages("checkAnswers.taxRegistrationNumbers.empty"),
              "taxRegistrationNumbersTitle",
                routes.ChangingAnswersController.changeYourTaxRegistrationNumbers() )
            
            <script>gaSendEvent('check-answers-tax-registration-numbers-empty')</script>
          
        }
    }
}

@formatFileName(fileName: String) = @{
if(fileName.length > 20){
    s"${fileName.take(10)}...${fileName.takeRight(10)}"
} else {
    fileName
}
}


@uk.gov.hmrc.agentoverseasapplicationfrontend.views.html.main_template(title = Messages("checkAnswers.title"), bodyClasses = None) {

    <a href="@backLink" class="link-back">@Messages("button.back")</a>

    <h1 class="heading-xlarge margin-bottom-30">@Messages("checkAnswers.title")</h1>

    @agentSession.amlsDetails.map { details =>

        <h2 class="heading-medium margin-bottom-10">@Messages("checkAnswers.amlsDetails.title")</h2>

        <div class="app-check-your-answers--group margin-bottom-30">
            <dl class="app-check-your-answers app-check-your-answers--long">
                <div class="app-check-your-answers__contents">
                    <dt class="app-check-your-answers__question">
                        @Messages("checkAnswers.amlsDetails.supervisoryBody")
                    </dt>
                    <dd class="app-check-your-answers__answers" id="amls-details-supervisory-body">
                        @details.supervisoryBody
                    </dd>
                    <dd class="app-check-your-answers__change">
                        <a href="@routes.ChangingAnswersController.changeAmlsDetails()" data-include-hidden="@Messages("checkAnswers.change.button") @Messages("checkAnswers.amlsDetails.title")">@Messages("checkAnswers.change.button") <span class="visuallyhidden"> @Messages("checkAnswers.amlsDetails.title")</span></a>
                    </dd>
                </div>

                <div class="app-check-your-answers__contents">
                    <dt class="app-check-your-answers__question">
                        @Messages("checkAnswers.amlsDetails.membershipNumber")
                    </dt>
                    <dd class="app-check-your-answers__answer" id="amls-details">
                        @details.membershipNumber
                    </dd>
                </div>
                <script>
                    @if(details.supervisoryBody.nonEmpty) {
                        gaSendEvent('check-answers-supervisory-body');
                    }
                    @if(details.membershipNumber.nonEmpty) {
                        gaSendEvent('check-answers-membership-number');
                    }
                </script>

            </dl>
        </div>
    }

    <div class="app-check-your-answers--group margin-bottom-10">
    @agentSession.amlsUploadStatus.flatMap(_.fileName).map { fileName =>
        <dl class="app-check-your-answers app-check-your-answers--long">
            @check_answers_div(Messages("checkAnswers.amlsFile.title"), formatFileName(fileName), "amlsFileName", routes.ChangingAnswersController.changeAmlsFile())
        </dl>
        <script>
            @if(fileName.nonEmpty) {
                    gaSendEvent('check-answers-amls-file-name');
                }
        </script>
    }
    </div>

    @agentSession.contactDetails.map { details =>

        <h2 class="heading-medium margin-bottom-10">@Messages("checkAnswers.contactDetails.title")</h2>

        <div class="app-check-your-answers--group margin-bottom-30">
            <dl class="app-check-your-answers app-check-your-answers--long">
                <div class="app-check-your-answers__contents">
                    <dt class="app-check-your-answers__question">
                        @Messages("checkAnswers.contactDetails.name")
                    </dt>
                    <dd class="app-check-your-answers__answer" id="name">
                        @details.firstName @details.lastName
                    </dd>
                    <dd class="app-check-your-answers__change">
                        <a href="@routes.ChangingAnswersController.changeContactDetails()" data-include-hidden="@Messages("checkAnswers.change.button") @Messages("checkAnswers.contactDetails.name")">@Messages("checkAnswers.change.button") <span class="visuallyhidden"> @Messages("checkAnswers.contactDetails.name")</span></a>
                    </dd>
                </div>
                <div class="app-check-your-answers__contents">
                    <dt class="app-check-your-answers__question">
                        @Messages("checkAnswers.contactDetails.jobTitle")
                    </dt>
                    <dd class="app-check-your-answers__answer" id="jobTitle">
                        @details.jobTitle
                    </dd>
                </div>
                <div class="app-check-your-answers__contents">
                    <dt class="app-check-your-answers__question">
                        @Messages("checkAnswers.contactDetails.businessTelephone")
                    </dt>
                    <dd class="app-check-your-answers__answer" id="businessTelephone">
                        @details.businessTelephone
                    </dd>
                </div>
                <div class="app-check-your-answers__contents">
                    <dt class="app-check-your-answers__question">
                        @Messages("checkAnswers.contactDetails.businessEmail")
                    </dt>
                    <dd class="app-check-your-answers__answer" id="businessEmail">
                        @details.businessEmail
                    </dd>
                </div>
            </dl>
        </div>
        <script>
            @if(details.firstName.nonEmpty) {
                gaSendEvent('check-answers-first-name');
            }
            @if(details.lastName.nonEmpty) {
                gaSendEvent('check-answers-last-name');
            }
            @if(details.jobTitle.nonEmpty) {
                gaSendEvent('check-answers-job-title');
            }
            @if(details.businessTelephone.nonEmpty) {
                gaSendEvent('check-answers-business-telephone');
            }
            @if(details.businessEmail.nonEmpty) {
                gaSendEvent('check-answers-business-email');
            }
        </script>
    }

    <h2 class="heading-medium margin-bottom-10">@Messages("checkAnswers.BusinessDetails.title")</h2>

    <div class="app-check-your-answers--group margin-bottom-10">
        @agentSession.tradingName.map { name =>
            <dl class="app-check-your-answers app-check-your-answers--long">
               @check_answers_div(Messages("checkAnswers.tradingName.title"), name, "tradingName", routes.ChangingAnswersController.changeTradingName())
            </dl>
            <script>
                @if(name.nonEmpty) {
                    gaSendEvent('check-answers-trading-name');
                }
            </script>
        }
    </div>
    <div class="app-check-your-answers--group margin-bottom-10">
        @agentSession.mainBusinessAddress.map { address =>
            <dl class="app-check-your-answers app-check-your-answers--long">
                @check_answers_div(
                    Messages("checkAnswers.mainBusinessAddress.title"),
                    Html(List(address.addressLine1,address.addressLine2, address.addressLine3.getOrElse(""), address.addressLine4.getOrElse(""), countryName).filter(_.nonEmpty).mkString("<br>")),
                    "mainBusinessAddressTitle",
                    routes.ChangingAnswersController.changeTradingAddress()
                )
            </dl>
            <script>
                @if(address.addressLine1.nonEmpty) {
                    gaSendEvent('check-answers-address-line1');
                }
                @if(address.addressLine2.nonEmpty) {
                    gaSendEvent('check-answers-address-line2');
                }
                @if(address.addressLine3.nonEmpty) {
                    gaSendEvent('check-answers-address-line3');
                }
                @if(address.addressLine4.nonEmpty) {
                    gaSendEvent('check-answers-address-line4');
                }
                @if(countryName.nonEmpty) {
                    gaSendEvent('check-answers-country-name');
                }
            </script>
        }
    </div>
    <div class="app-check-your-answers--group margin-bottom-10">
        @agentSession.tradingAddressUploadStatus.flatMap(_.fileName).map { fileName =>
            <dl class="app-check-your-answers app-check-your-answers--long">
                @check_answers_div(Messages("checkAnswers.tradingAddressFile.title"), formatFileName(fileName), "tradingAddressFileName", routes.ChangingAnswersController.changeTradingAddressFile())
            </dl>
            <script>
                @if(fileName.nonEmpty) {
                    gaSendEvent('check-answers-trading-address-file-name');
                }
            </script>
        }
    </div>

    <h2 class="heading-medium margin-bottom-10">@Messages("checkAnswers.OtherBusinessDetails.title")</h2>

    <div class="app-check-your-answers--group margin-bottom-30">
        @agentSession.registeredWithHmrc.map { isRegistered =>

            <dl class="app-check-your-answers app-check-your-answers--long">
                @check_answers_div(Messages("checkAnswers.registeredWithHmrc.title"), isRegistered, "isRegistered", routes.ChangingAnswersController.changeRegisteredWithHmrc())
                <script>
                    @if(isRegistered == Yes) {
                        gaSendEvent('check-answers-is-registered');
                    }
                </script>
                @if(isRegistered == Yes && agentSession.agentCodes.map(_.hasOneOrMoreCodes).contains(true)) {
                    @agentSession.agentCodes.flatMap(_.selfAssessment).map { sa =>
                        @check_answers_div(Messages("checkAnswers.agentCode.selfAssessment"), sa.value, "sa", routes.ChangingAnswersController.changeAgentCodes())
                        <script>gaSendEvent('check-answers-sa')</script>
                    }

                    @agentSession.agentCodes.flatMap(_.corporationTax).map { ct =>
                        @check_answers_div(Messages("checkAnswers.agentCode.corporationTax"), ct.value, "ct", routes.ChangingAnswersController.changeAgentCodes())
                        <script>gaSendEvent('check-answers-ct')</script>
                    }
                }

                @if(isRegistered == Yes && agentSession.agentCodes.map(_.isEmpty).contains(true)) {
                    @check_answers_div(Messages("checkAnswers.agentCode.title"),  Messages("checkAnswers.agentCode.empty"), "agentCodeEmpty", routes.ChangingAnswersController.changeAgentCodes())
                    @showFullBusinessDetails
                }

                @if(isRegistered == No){
                   @showFullBusinessDetails
                }
            </dl>
        }
    </div>

    @if(agentSession.trnUploadStatus.isDefined) {
        <div class="app-check-your-answers--group margin-bottom-10">
        @agentSession.trnUploadStatus.flatMap(_.fileName).map { fileName =>
            <dl class="app-check-your-answers app-check-your-answers--long">
                @check_answers_div(Messages("checkAnswers.taxRegistrationNumbersFile.title"), formatFileName(fileName), "trnFileName", routes.ChangingAnswersController.changeYourTaxRegistrationNumbersFile())
            </dl>
            <script>
                @if(fileName.nonEmpty) {
                    gaSendEvent('check-answers-trn-file-name');
                }
            </script>
        }
        </div>
    }

    <p class="margin-top-30">@Messages("checkAnswers.confirm.p1")</p>

    @form(
        action = routes.ApplicationController.submitCheckYourAnswers(),
        'class -> "form js-form") {

        <div class="form-group">
            <button class="button margin-top-30" type="submit" id="continue" >@Messages("checkAnswers.confirm.button")</button>
        </div>
    }

}
